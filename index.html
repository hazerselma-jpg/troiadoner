<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Troia D√∂ner | Online Sipari≈ü</title>

  <style>
    :root{
      --bg-1:#0c0a10; --bg-2:#171320;
      --accent:#f6d365; --accent-2:#fda085;
      --card: rgba(24,20,32,0.78);
      --muted:#bfbfc3;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#f5f5f5;background:
      radial-gradient(120% 140% at 20% 20%, rgba(253,160,133,0.12), transparent 40%),
      radial-gradient(120% 120% at 80% 0%, rgba(246,211,101,0.12), transparent 38%),
      linear-gradient(145deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
    .page{max-width:1000px;margin:16px auto;padding:22px;border-radius:18px;background:linear-gradient(120deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;align-items:center;gap:14px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.04)}
    header img.logo{height:64px;width:auto;border-radius:10px;background:rgba(255,255,255,0.02);padding:6px}
    header .brand{display:flex;flex-direction:column}
    header h1{margin:0;font-size:1.6rem;letter-spacing:.08em;text-transform:uppercase}
    header p{margin:4px 0 0;color:var(--muted);font-size:.95rem}

    .hero{display:flex;gap:20px;flex-wrap:wrap;align-items:center;padding:18px 0}
    .hero-text{flex:1 1 360px}
    .hero-text h2{font-size:1.5rem;margin:0 0 6px}
    .hero-text p{color:#dcdcdc;margin:0 0 10px}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .tag{background:var(--glass);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-size:.85rem}

    .btn-main{display:inline-block;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#111;padding:10px 16px;border-radius:999px;font-weight:800;text-decoration:none}

    /* menu */
    .menu{margin-top:18px}
    .menu h2{margin:0 0 12px;font-size:1.2rem}
    .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}

    .item{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 26px rgba(0,0,0,0.45);display:flex;flex-direction:column;gap:8px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .item-name{font-weight:800}
    .item-price{color:#f5c451;font-weight:800}
    .item-desc{color:#d7d7d7;font-size:.95rem}
    .item-note{color:var(--muted);font-size:.85rem}

    .item-actions{display:flex;gap:8px;align-items:center;margin-top:6px}
    .qty-input{width:76px;padding:8px;border-radius:8px;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.04);color:#fff}
    .btn-action{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:#fff;cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#111;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800}

    .item-opts{display:none;margin-top:10px;border-top:1px solid rgba(255,255,255,0.03);padding-top:10px;gap:8px}
    .option-group{margin-bottom:6px}
    .options-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
    .option-choice{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .option-label{font-size:.92rem;color:#e9e9e9}

    /* cart */
    .cart-toggle{position:fixed;right:18px;bottom:18px;z-index:10001}
    .cart-toggle button{background:linear-gradient(0deg,#111,#1b1b1b);color:#fff;border-radius:14px;padding:12px 16px;border:1px solid rgba(255,255,255,0.04);font-weight:800;box-shadow:0 14px 40px rgba(0,0,0,0.45)}
    .cart-panel{position:fixed;right:18px;bottom:72px;width:min(460px,96%);max-height:80vh;overflow:auto;z-index:10001;background:linear-gradient(180deg, rgba(10,10,12,0.98), rgba(16,16,20,0.98));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.04);display:none}
    .cart-item{display:flex;gap:10px;align-items:flex-start;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .cart-item-name{font-weight:800}
    .cart-controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    .cart-controls button{background:transparent;border-radius:8px;padding:6px 8px;border:1px solid rgba(255,255,255,0.04);color:#fff;cursor:pointer}
    .cart-total{margin-top:10px;display:flex;justify-content:space-between;align-items:center;font-weight:900;font-size:1.1rem;color:#f5c451}
    .checkout-form{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .checkout-form input,.checkout-form textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.4);color:#fff}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;place-items:center;z-index:10002}
    .modal{background:linear-gradient(180deg, rgba(18,18,20,0.98), rgba(22,22,26,0.98));padding:16px;border-radius:12px;max-width:520px;width:min(95%,520px);border:1px solid rgba(255,255,255,0.04)}
    .modal h3{margin:0 0 8px}
    .modal .modal-body{max-height:60vh;overflow:auto;margin-bottom:8px}
    .modal .modal-actions{display:flex;gap:8px;justify-content:flex-end}

    /* toast */
    .toast{position:fixed;right:22px;bottom:110px;background:rgba(0,0,0,0.9);color:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.6);opacity:0;transform:translateY(8px);transition:opacity .22s,transform .22s;z-index:10003;pointer-events:none}
    .toast.show{opacity:1;transform:translateY(0);pointer-events:auto}

    /* small screens */
    @media (max-width:720px){
      header{flex-direction:row;align-items:center}
      header img.logo{height:48px}
      .menu-grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
      .cart-panel{left:8px;right:8px;width:auto}
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <!-- Add your logo image file as "logo.png" in the same folder as this HTML file -->
      <img class="logo" src="logo.png" alt="Troia D√∂ner Logo" onerror="this.style.display='none'">
      <div class="brand">
        <h1>TROIA <span style="color:#f5c451">D√ñNER</span></h1>
        <p>Tarihten gelen lezzet ¬∑ √áanakkale</p>
      </div>
    </header>

    <section class="hero" aria-hidden="false">
      <div class="hero-text">
        <h2>Sƒ±cak, taze, sosu tam kararƒ±nda d√∂ner.</h2>
        <p>Aynƒ± anda sokak lezzeti, hem sessiz l√ºks. Troia D√∂ner ≈üimdi √ßevrim i√ßi sipari≈üle cebinde.</p>
        <div class="tags">
          <div class="tag">üî• G√ºnl√ºk taze √ºr√ºn</div>
          <div class="tag">üöö Paket servis</div>
          <div class="tag">üìç √áanakkale merkez</div>
        </div>
        <a class="btn-main" id="quickWhatsApp" href="https://wa.me/905415788507" target="_blank" rel="noopener">WhatsApp'tan Sipari≈ü Ver</a>
      </div>
      <div style="flex:0 0 260px">
        <div style="background:rgba(0,0,0,0.28);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)">
          <h3 style="margin:0 0 8px">Bug√ºn√ºn √∂nerisi</h3>
          <p id="hero-suggestion" style="margin:0;color:#ddd">Pilav√ºst√º tavuk d√∂ner + ayran ¬∑ sosu bol, soƒüan isteƒüe baƒülƒ±.</p>
        </div>
      </div>
    </section>

    <section class="menu">
      <h2>Men√º</h2>
      <div class="menu-grid" id="menuGrid" aria-live="polite"></div>
    </section>

    <section style="margin-top:18px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
      <div style="background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)">
        <h3 style="color:#f5c451;margin:0 0 6px">√áalƒ±≈üma Saatleri</h3>
        <p style="color:var(--muted);margin:0">Her g√ºn: 11.00 ‚Äì 23.00<br>Yoƒüun: 12.00‚Äì14.00 / 18.00‚Äì21.00</p>
      </div>
      <div style="background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)">
        <h3 style="color:#f5c451;margin:0 0 6px">Konum</h3>
        <p style="color:var(--muted);margin:0">Troia D√∂ner ¬∑ √áanakkale Merkez<br><a href="https://maps.google.com/?q=Troia%20D%C3%B6ner%20%C3%87anakkale" target="_blank" rel="noopener">Haritayƒ± a√ß</a></p>
      </div>
      <div style="background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)">
        <h3 style="color:#f5c451;margin:0 0 6px">Telefon</h3>
        <p style="color:var(--muted);margin:0"><a href="tel:+905415788507">0 (541) 578 85 07</a></p>
      </div>
    </section>
  </div>

  <!-- cart toggle & panel -->
  <div class="cart-toggle"><button id="cartToggle">Sepetim (<span id="cartCount">0</span>)</button></div>

  <div class="cart-panel" id="cartPanel" aria-hidden="true">
    <h3>Sepetiniz</h3>
    <div id="cartList" aria-live="polite"></div>

    <div class="cart-total">
      <div>Toplam</div>
      <div id="cartTotal">‚Ç∫ 0,00</div>
    </div>

    <div style="margin-top:10px">
      <strong>Teslimat bilgileri</strong>
      <div class="checkout-form">
        <input id="custName" placeholder="ƒ∞sim (√∂r. Ahmet)" />
        <input id="custPhone" placeholder="Telefon (√∂rn. +905xxxxxxxxx)" />
        <textarea id="custAddress" rows="2" placeholder="Adres (detaylƒ±)"></textarea>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="clearCartBtn" class="btn-action">Temizle</button>
      <button id="saveInfoBtn" class="btn-action">Bilgileri Kaydet</button>
      <a id="checkoutBtn" class="btn-primary" href="#" target="_blank" rel="noopener">WhatsApp ile G√∂nder</a>
    </div>

    <div style="margin-top:8px;color:var(--muted);font-size:.85rem">WhatsApp'ƒ± kullanarak sipari≈ü g√∂nderirken isim/telefon/adres otomatik eklenir. Bilgiler cihazƒ±nƒ±zda saklanƒ±r.</div>
  </div>

  <!-- modal for add/option confirmation -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document" id="itemModal">
      <h3 id="modalTitle">√úr√ºn</h3>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions">
        <button id="modalCancel" class="btn-action">ƒ∞ptal</button>
        <button id="modalConfirm" class="btn-primary">Sepete Ekle</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" aria-hidden="true">Sepete eklendi</div>

  <script>
  (function(){
    // keys
    const STORAGE_KEY = 'troia_menu_v2';
    const CART_KEY = 'troia_cart_v2';
    const CUST_KEY = 'troia_customer_v2';

    // default menu ‚Äî you can edit via admin or inline
    const defaultMenu = [
      { id:'m1', name:'Pilav√ºst√º Tavuk D√∂ner', priceDisplay:'‚Ç∫ 45', priceNum:45, desc:'Tane tane pirin√ß pilav √ºzerinde ince dilim tavuk d√∂ner, domates ve mor soƒüan.' },
      { id:'m2', name:'Pilav√ºst√º Et D√∂ner', priceDisplay:'‚Ç∫ 58', priceNum:58, desc:'√ñzel marinasyonlu et d√∂ner, tereyaƒülƒ± pilav ve taze salata.' },
      { id:'m3', name:'Lava≈ü D√ºr√ºm (Tavuk)', priceDisplay:'‚Ç∫ 38', priceNum:38, desc:'√ñzel lava≈üta tavuk d√∂ner, salata, tur≈üu.' , options:[
          { groupName:'Yan Se√ßenekler', type:'multi', choices:[ {id:'p1', name:'Patates', price:18}, {id:'s1', name:'Mevsim Salata', price:10} ] }
        ]
      },
      // drinks as standalone items
      { id:'d1', name:'Ayran 330ml', priceDisplay:'‚Ç∫ 8', priceNum:8, desc:'Serinletici ayran.', category:'drink' },
      { id:'d2', name:'Kola 330ml', priceDisplay:'‚Ç∫ 12', priceNum:12, desc:'Soƒüuk kola.', category:'drink' },
      { id:'d3', name:'≈ûalgam 330ml', priceDisplay:'‚Ç∫ 10', priceNum:10, desc:'Ev yapƒ±mƒ± ≈üalgam.', category:'drink' },
      { id:'m10', name:'Men√º: Pilav√ºst√º Tavuk + Ayran', priceDisplay:'‚Ç∫ 52', priceNum:52, desc:'Pilav√ºst√º tavuk d√∂ner ve 330ml ayran (men√º fiyatƒ±).', options:[
          { groupName:'Men√ºye ekle', type:'multi', choices:[ {id:'mp1', name:'Patates +‚Ç∫18', price:18} ] },
          { groupName:'ƒ∞√ßecek se√ß', type:'single', choices:[ {id:'md1', name:'Ayran (dahil)', price:0}, {id:'md2', name:'Kola (+‚Ç∫4)', price:4}, {id:'md3', name:'≈ûalgam (+‚Ç∫2)', price:2} ] }
        ]
      }
    ];

    // load/save
    function loadMenu(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return defaultMenu.slice(); const parsed = JSON.parse(raw); return Array.isArray(parsed)?parsed:defaultMenu.slice(); }catch(e){ console.error(e); return defaultMenu.slice(); } }
    function saveMenu(menu){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(menu)); }catch(e){} }
    function loadCart(){ try{ const raw = localStorage.getItem(CART_KEY); if(!raw) return []; const p = JSON.parse(raw); return Array.isArray(p)?p:[] }catch(e){ return []; } }
    function saveCart(){ try{ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }catch(e){} }
    function loadCustomer(){ try{ const raw = localStorage.getItem(CUST_KEY); if(!raw) return {}; return JSON.parse(raw)||{} }catch(e){ return {}; } }
    function saveCustomer(c){ try{ localStorage.setItem(CUST_KEY, JSON.stringify(c)); }catch(e){} }

    // state
    let menuData = loadMenu();
    let cart = loadCart();
    let customer = loadCustomer();

    // elements
    const menuGrid = document.getElementById('menuGrid');
    const cartCountEl = document.getElementById('cartCount');
    const cartPanel = document.getElementById('cartPanel');
    const cartListEl = document.getElementById('cartList');
    const cartTotalEl = document.getElementById('cartTotal');
    const custName = document.getElementById('custName');
    const custPhone = document.getElementById('custPhone');
    const custAddress = document.getElementById('custAddress');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalConfirm = document.getElementById('modalConfirm');
    const modalCancel = document.getElementById('modalCancel');

    // utility
    function formatCurrency(n){ return '‚Ç∫ ' + Number(n).toFixed(2).replace('.',','); }
    function parsePriceFromString(str){ const m = String(str).replace(',','.').match(/(\d+(\.\d+)?)/); return m?parseFloat(m[0]):0; }
    function showToast(msg, ms=1200){ const t=document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); t.setAttribute('aria-hidden','false'); clearTimeout(t._hide); t._hide = setTimeout(()=>{ t.classList.remove('show'); t.setAttribute('aria-hidden','true') }, ms); }

    // render menu
    function renderMenu(){
      if(!menuGrid) return;
      menuGrid.innerHTML = '';
      menuData.forEach(item => {
        const el = document.createElement('div');
        el.className = 'item';
        el.dataset.menuId = item.id;
        el.innerHTML = `
          <div class="row">
            <div class="item-name">${escapeHtml(item.name)}</div>
            <div class="item-price">${escapeHtml(item.priceDisplay || '')}</div>
          </div>
          <div class="item-desc">${escapeHtml(item.desc || '')}</div>
          <div class="item-note">${item.note?escapeHtml(item.note):''}</div>
          <div class="item-actions">
            <input class="qty-input" type="number" min="1" value="1" aria-label="Adet" />
            <button class="btn-action btn-add">Sepete Ekle</button>
            ${ item.options ? '<button class="btn-action btn-toggle-opts">Se√ßenekler</button>' : '' }
          </div>
          <div class="item-opts" aria-hidden="true"></div>
        `;
        menuGrid.appendChild(el);

        // options area populate
        if(item.options && item.options.length){
          const opts = el.querySelector('.item-opts');
          opts.style.display = 'none';
          item.options.forEach((g,gidx) => {
            const group = document.createElement('div');
            group.className = 'option-group';
            group.innerHTML = `<div style="font-weight:700;color:#f5c451;margin-bottom:6px">${escapeHtml(g.groupName)}</div><div class="options-grid"></div>`;
            const grid = group.querySelector('.options-grid');
            g.choices.forEach(ch => {
              const choice = document.createElement('label');
              choice.className = 'option-choice';
              choice.innerHTML = `<input type="${g.type==='single'?'radio':'checkbox'}" name="opt-${item.id}-${gidx}" value="${escapeHtml(ch.id)}" data-name="${escapeHtml(ch.name)}" data-price="${Number(ch.price||0)}" /> <div style="margin-left:6px"><div class="option-label">${escapeHtml(ch.name)}${ch.price?(' ‚Äî '+formatCurrency(ch.price)):''}</div></div>`;
              grid.appendChild(choice);
            });
            opts.appendChild(group);
          });
        }
      });
    }

    // event delegation for menu interactions
    menuGrid.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if(!btn) return;
      const itemEl = btn.closest('.item');
      if(!itemEl) return;
      const id = itemEl.dataset.menuId;
      const item = menuData.find(x => x.id === id);
      if(!item) return;

      if(btn.classList.contains('btn-toggle-opts')){
        const opts = itemEl.querySelector('.item-opts');
        const isHidden = opts.style.display === 'none' || opts.style.display === '';
        opts.style.display = isHidden ? 'block' : 'none';
        opts.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
        return;
      }

      if(btn.classList.contains('btn-add')){
        // open modal to confirm and choose options (also used on drinks)
        openAddModal(item, itemEl);
      }
    });

    // open modal (shows quantity, options if any; confirm adds to cart)
    function openAddModal(item, itemEl){
      modalTitle.textContent = item.name + (item.priceDisplay ? (' ‚Äî '+item.priceDisplay) : '');
      modalBody.innerHTML = '';
      const wrapper = document.createElement('div');

      // quantity
      const qtyRow = document.createElement('div');
      qtyRow.style.display = 'flex'; qtyRow.style.gap = '8px'; qtyRow.style.alignItems = 'center'; qtyRow.style.marginBottom = '8px';
      qtyRow.innerHTML = `<label style="font-weight:700">Adet</label><input id="modalQty" type="number" min="1" value="${(itemEl && itemEl.querySelector('.qty-input'))?escapeHtml(itemEl.querySelector('.qty-input').value || 1):1}" style="padding:6px;border-radius:6px;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.04);color:#fff;width:90px" />`;
      wrapper.appendChild(qtyRow);

      // options (if any)
      if(item.options && item.options.length){
        item.options.forEach((g,gidx) => {
          const groupWrap = document.createElement('div');
          groupWrap.style.marginBottom = '10px';
          const title = document.createElement('div'); title.style.fontWeight = '700'; title.style.color = '#f5c451'; title.style.marginBottom = '6px'; title.textContent = g.groupName;
          groupWrap.appendChild(title);
          const grid = document.createElement('div'); grid.className = 'options-grid';
          grid.style.marginBottom = '6px';
          g.choices.forEach(choice => {
            const label = document.createElement('label');
            label.className = 'option-choice';
            label.style.cursor = 'pointer';
            label.innerHTML = `<input type="${g.type==='single'?'radio':'checkbox'}" name="modal-opt-${item.id}-${gidx}" value="${escapeHtml(choice.id)}" data-name="${escapeHtml(choice.name)}" data-price="${Number(choice.price||0)}" /> <div style="margin-left:6px"><div style="font-weight:700">${escapeHtml(choice.name)}</div><div style="color:var(--muted);font-size:.9rem">${choice.price?formatCurrency(choice.price):''}</div></div>`;
            grid.appendChild(label);
          });
          groupWrap.appendChild(grid);
          wrapper.appendChild(groupWrap);
        });
      } else {
        // If this is a drink item, show price clearly and allow extra notes
        if(item.category === 'drink' || String(item.id).startsWith('d')){
          const p = document.createElement('div');
          p.style.marginBottom = '8px';
          p.innerHTML = `<div style="font-weight:700">Fiyat</div><div style="color:var(--muted)">${item.priceDisplay || ''}</div>`;
          wrapper.appendChild(p);
        }
      }

      // optional notes
      const notes = document.createElement('textarea');
      notes.id = 'modalNotes';
      notes.placeholder = 'Sipari≈ü notu (√∂rn. sos, soƒüan tercihi)';
      notes.style.width = '100%';
      notes.style.padding = '8px';
      notes.style.borderRadius = '8px';
      notes.style.background = 'rgba(0,0,0,0.4)';
      notes.style.border = '1px solid rgba(255,255,255,0.04)';
      notes.style.color = '#fff';
      notes.style.minHeight = '64px';
      wrapper.appendChild(notes);

      modalBody.appendChild(wrapper);

      // show modal
      modalBackdrop.style.display = 'grid';
      modalBackdrop.setAttribute('aria-hidden','false');

      // on confirm, collect data and add
      function onConfirm(){
        const qty = Math.max(1, Number(document.getElementById('modalQty').value) || 1);
        const selectedMods = [];
        modalBody.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(inp => {
          if((inp.type==='checkbox' && inp.checked) || (inp.type==='radio' && inp.checked)){
            selectedMods.push({ id: inp.value, name: inp.dataset.name || inp.getAttribute('data-name') || '', price: Number(inp.dataset.price || inp.getAttribute('data-price') || 0) });
          }
        });
        const note = document.getElementById('modalNotes').value.trim();
        addToCart(item, qty, selectedMods, note);
        closeModal();
      }

      modalConfirm.onclick = onConfirm;
      modalCancel.onclick = closeModal;
      modalBackdrop.onclick = function(e){
        if(e.target === modalBackdrop) closeModal();
      };
    }

    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
      modalConfirm.onclick = null;
      modalCancel.onclick = null;
      modalBackdrop.onclick = null;
      modalBody.innerHTML = '';
    }

    // add to cart
    function addToCart(item, qty, mods=[], note=''){
      const base = Number(item.priceNum || parsePriceFromString(item.priceDisplay || '0')) || 0;
      const cartItem = {
        cartId: 'c_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),
        id: item.id,
        name: item.name,
        basePrice: base,
        qty: qty,
        mods: mods || [],
        note: note || ''
      };
      cart.push(cartItem);
      saveCart();
      renderCart();
      showToast('Sepete eklendi');
    }

    // render cart
    function renderCart(){
      cartListEl.innerHTML = '';
      let total = 0;
      cart.forEach((ci, idx) => {
        const modsTotal = (ci.mods || []).reduce((s,m) => s + Number(m.price || 0), 0);
        const itemTotal = (ci.basePrice + modsTotal) * ci.qty;
        total += itemTotal;
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <div>
            <div class="cart-item-name">${escapeHtml(ci.name)}</div>
            <div style="color:var(--muted)">${ci.qty} x ${formatCurrency(ci.basePrice)}</div>
            ${ci.mods && ci.mods.length ? '<div style="color:#ccc;margin-top:6px;font-size:.92rem">'+ci.mods.map(m => escapeHtml(m.name)).join(', ') +'</div>' : ''}
            ${ci.note ? '<div style="color:var(--muted);font-size:.9rem;margin-top:6px">Not: '+escapeHtml(ci.note)+'</div>' : ''}
          </div>
          <div class="cart-controls">
            <div style="font-weight:800;color:#f5c451">${formatCurrency(itemTotal)}</div>
            <button data-action="minus" data-idx="'+idx+'">-</button>
            <button data-action="plus" data-idx="'+idx+'">+</button>
            <button data-action="remove" data-idx="'+idx+'">‚úï</button>
          </div>
        `.replaceAll('"data-idx"', '"data-idx"'); // keep attributes valid

        // attach control events inline to avoid delegation issues
        const controls = row.querySelectorAll('button');
        controls.forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = btn.getAttribute('data-action');
            const index = Number(btn.getAttribute('data-idx'));
            if(isNaN(index)) return;
            if(action === 'remove'){ cart.splice(index,1); saveCart(); renderCart(); }
            if(action === 'minus'){ cart[index].qty = Math.max(1, cart[index].qty - 1); saveCart(); renderCart(); }
            if(action === 'plus'){ cart[index].qty = cart[index].qty + 1; saveCart(); renderCart(); }
          });
        });

        cartListEl.appendChild(row);
      });

      cartCountEl.textContent = cart.length;
      cartTotalEl.textContent = formatCurrency(total);

      // update checkout link (but require saved customer info)
      updateCheckoutHref();
    }

    // update the checkout href (but we will validate on click)
    function buildOrderText(){
      if(!cart || cart.length === 0) return '';
      let lines = [];
      cart.forEach((ci, i) => {
        const modsText = ci.mods && ci.mods.length ? ' - Se√ßenekler: ' + ci.mods.map(m => m.name).join(', ') : '';
        const noteText = ci.note ? (' - Not: '+ci.note) : '';
        const itemTotal = (ci.basePrice + (ci.mods||[]).reduce((s,m)=>s+Number(m.price||0),0)) * ci.qty;
        lines.push(`${i+1}. ${ci.name} x${ci.qty}${modsText}${noteText} = ${formatCurrency(itemTotal)}`);
      });
      const total = cart.reduce((s,ci)=> s + (ci.basePrice + (ci.mods||[]).reduce((ss,m)=>ss + Number(m.price||0),0)) * ci.qty, 0);
      lines.push('');
      lines.push('Toplam: ' + formatCurrency(total));
      return lines.join('\n');
    }

    function updateCheckoutHref(){
      // We won't open wa link directly here; checkout button will validate fields then build final link and open
      // But keep a default
      document.getElementById('checkoutBtn').href = 'https://wa.me/905415788507';
    }

    // cart toggle
    document.getElementById('cartToggle').addEventListener('click', () => {
      const isHidden = cartPanel.style.display === 'none' || cartPanel.style.display === '';
      cartPanel.style.display = isHidden ? 'block' : 'none';
      cartPanel.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
      // populate saved customer info
      const c = loadCustomer() || {};
      if(c.name) custName.value = c.name;
      if(c.phone) custPhone.value = c.phone;
      if(c.address) custAddress.value = c.address;
      renderCart();
    });

    // clear cart
    document.getElementById('clearCartBtn').addEventListener('click', () => {
      if(confirm('Sepeti temizlemek istiyor musunuz?')){ cart = []; saveCart(); renderCart(); }
    });

    // save customer info
    document.getElementById('saveInfoBtn').addEventListener('click', () => {
      const c = { name: custName.value.trim(), phone: custPhone.value.trim(), address: custAddress.value.trim() };
      if(!c.name || !c.phone || !c.address){ alert('L√ºtfen isim, telefon ve adres bilgilerini doldurun.'); return; }
      customer = c;
      saveCustomer(customer);
      showToast('Bilgiler kaydedildi');
    });

    // checkout: validate and open WhatsApp with message including customer info and order lines + total
    document.getElementById('checkoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if(cart.length === 0){ alert('Sepetiniz bo≈ü. √ñnce √ºr√ºn ekleyin.'); return; }
      const c = {
        name: custName.value.trim(),
        phone: custPhone.value.trim(),
        address: custAddress.value.trim()
      };
      if(!c.name || !c.phone || !c.address){
        // focus first empty
        if(!c.name){ custName.focus(); alert('L√ºtfen isim girin.'); }
        else if(!c.phone){ custPhone.focus(); alert('L√ºtfen telefon girin.'); }
        else if(!c.address){ custAddress.focus(); alert('L√ºtfen adres girin.'); }
        return;
      }
      // Save customer for next time
      customer = c;
      saveCustomer(customer);

      // build message
      const orderText = buildOrderText();
      const msgLines = [
        `Merhaba, sipari≈ü veriyorum.`,
        '',
        orderText,
        '',
        `ƒ∞sim: ${customer.name}`,
        `Telefon: ${customer.phone}`,
        `Adres: ${customer.address}`,
        '',
        `L√ºtfen tahmini teslim s√ºresini yazƒ±nƒ±z.`
      ];
      const message = encodeURIComponent(msgLines.join('\n'));
      const wa = `https://wa.me/905415788507?text=${message}`;
      // For desktop, wa.me will open WhatsApp Web if available; for mobile it opens WhatsApp app ‚Äî works for iOS, Android and desktop.
      window.open(wa, '_blank');
    });

    // utility escape
    function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    // load customer into inputs on start
    (function initCustomer(){
      const c = loadCustomer() || {};
      if(c.name) custName.value = c.name;
      if(c.phone) custPhone.value = c.phone;
      if(c.address) custAddress.value = c.address;
    })();

    // initial render
    renderMenu();
    renderCart();

    // small helper: link "quickWhatsApp" should use cart when clicked ‚Äî open cart panel and show message
    document.getElementById('quickWhatsApp').addEventListener('click', (e) => {
      e.preventDefault();
      // open cart panel
      cartPanel.style.display = 'block';
      cartPanel.setAttribute('aria-hidden','false');
      renderCart();
      showToast('Sepeti kontrol edip "WhatsApp ile G√∂nder"e basƒ±n', 1400);
    });

    // ensure keyboard/backdrop closes modal with ESC
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        if(modalBackdrop.style.display === 'grid') closeModal();
        else if(cartPanel.style.display === 'block'){ cartPanel.style.display = 'none'; cartPanel.setAttribute('aria-hidden','true'); }
      }
    });

    // expose some helpers for debugging in console if needed
    window.__troia = {
      menuData, cart,
      addToCart,
      saveMenu: () => saveMenu(menuData),
      clearCart: () => { cart = []; saveCart(); renderCart(); }
    };

  })();
  </script>
</body>
</html>
